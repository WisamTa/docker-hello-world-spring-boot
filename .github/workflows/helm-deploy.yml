name: Helm Deploy to GKE

on:
  push:
    branches: [ "master" ]
    paths-ignore:
      - "**.md"
      - "Notes.md"
      - "*.txt"
  pull_request:
    branches: []
    paths-ignore:
      - "**.md"
      - "Notes.md"
      - "*.txt"

env:
  REGISTRY: europe-docker.pkg.dev
  GCP_PROJECT: curamet-onboarding
  ARTIFACT_REPO: spring-boot
  IMAGE_NAME: spring-boot-hello
  IMAGE_TAG: spring
  GKE_CLUSTER: autopilot-cluster-1
  GKE_REGION: europe-north1
  HELM_RELEASE_NAME: spring-release
  HELM_NAMESPACE: spring
  HELM_CHART_PATH: ./first-chart

permissions:
  contents: read
  id-token: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Run Tests
        run: mvn test
        continue-on-error: true

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: spring-boot-jar
          path: target/*.jar
          retention-days: 5

  build-and-push-image:
    runs-on: ubuntu-latest
    name: Build & Push Docker Image
    needs: build-and-test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.REGISTRY }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.REGISTRY }}/${{ env.GCP_PROJECT }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy-with-helm:
    runs-on: ubuntu-latest
    name: Deploy with Helm to GKE
    needs: build-and-push-image
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # ========================================
      # 1. AUTHENTICATE WITH GOOGLE CLOUD
      # ========================================
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # ========================================
      # 2. SETUP GCLOUD SDK
      # ========================================
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # ========================================
      # 3. INSTALL HELM
      # ========================================
      - name: Install Helm
        run: |
          curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

      # ========================================
      # 3.5 INSTALL GKE AUTH PLUGIN
      # ========================================
      - name: Install gke-gcloud-auth-plugin
        run: |
          gcloud components install gke-gcloud-auth-plugin --quiet
          echo "$(gcloud info --format='value(installation.sdk_root)')/bin" >> $GITHUB_PATH

      # ========================================
      # 4. GET GKE CREDENTIALS
      # ========================================
      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} \
            --region ${{ env.GKE_REGION }} \
            --project ${{ env.GCP_PROJECT }}

      # ========================================
      # 5. CREATE NAMESPACE IF NOT EXISTS
      # ========================================
      - name: Create Kubernetes Namespace
        run: |
          kubectl create namespace ${{ env.HELM_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      # ========================================
      # 6. HELM CHART LINT
      # ========================================
      - name: Lint Helm Chart
        run: |
          helm lint ${{ env.HELM_CHART_PATH }}

      # ========================================
      # 7. HELM DRY-RUN (Preview Changes)
      # ========================================
      - name: Helm Dry-Run
        run: |
          helm upgrade ${{ env.HELM_RELEASE_NAME }} ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --install \
            --dry-run \
            --debug

      # ========================================
      # 8. HELM UPGRADE/INSTALL
      # ========================================
      - name: Deploy with Helm
        run: |
          helm upgrade ${{ env.HELM_RELEASE_NAME }} ${{ env.HELM_CHART_PATH }} \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --install \
            --wait \
            --timeout 5m

      # ========================================
      # 9. VERIFY DEPLOYMENT
      # ========================================
      - name: Verify Helm Release
        run: |
          echo "Helm Release Status:"
          helm status ${{ env.HELM_RELEASE_NAME }} -n ${{ env.HELM_NAMESPACE }}
          
          echo -e "\n=== Pods Status ==="
          kubectl get pods -n ${{ env.HELM_NAMESPACE }}
          
          echo -e "\n=== Services ==="
          kubectl get svc -n ${{ env.HELM_NAMESPACE }}

      # ========================================
      # 10. CHECK ROLLOUT STATUS
      # ========================================
      - name: Wait for Rollout
        run: |
          kubectl rollout status deployment/spring-hello-world \
            --namespace ${{ env.HELM_NAMESPACE }} \
            --timeout=5m

      # ========================================
      # 11. HELM HISTORY
      # ========================================
      - name: Show Helm Release History
        if: always()
        run: |
          helm history ${{ env.HELM_RELEASE_NAME }} -n ${{ env.HELM_NAMESPACE }}
